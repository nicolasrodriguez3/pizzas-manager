// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// Users for authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ingredients  Ingredient[]
  products     Product[]
  sales        Sale[]
  organization OrganizationMember?
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     OrganizationMember[]
  products    Product[]
  ingredients Ingredient[]
  sales       Sale[]
  fixedCosts  FixedCost[]
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @unique
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("OWNER") // OWNER, MEMBER

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
}

// Ingredients that go into Pizzas or are sold directly (if applicable, though usually Products are sold)
model Ingredient {
  id     String @id @default(cuid())
  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  unit        String // e.g., "kg", "grams", "liters", "units"
  cost        Float // Cost per unit
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recipeItems RecipeItem[]

  @@index([name])
  @@index([isActive])
  @@index([userId])
  @@index([organizationId])
}

// Products are what is actually sold (Pizzas, Sodas, etc.)
model Product {
  id     String @id @default(cuid())
  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name         String
  slug         String
  type         String // "ELABORADO", "REVENTA", "OTHER" - could be an enum but string is flexible for SQLite
  category     String? // e.g., "Clasicas", "Gourmet", "Bebidas Alcoholicas"
  subCategory  String? // e.g., "Pizzas", "Empanadas", "Bebidas" - subcategory within product type
  basePrice    Float
  manualCost   Float? // Cost for REVENTA/OTHER products (manual entry, not calculated from recipe)
  isActive     Boolean      @default(true)
  description  String?
  receipeItems RecipeItem[] @relation("ProductRecipe") // Only relevant for complex products like Pizzas

  // New relation for when this product is used in another product's recipe
  usedInRecipes RecipeItem[] @relation("SubProductRecipe")

  saleItems SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([slug])
  @@index([type])
  @@index([isActive])
  @@index([userId])
  @@index([organizationId])
}

// Link Table to define what ingredients go into a Product (mostly for Pizzas)
model RecipeItem {
  id String @id @default(cuid())

  productId String
  product   Product @relation("ProductRecipe", fields: [productId], references: [id], onDelete: Cascade)

  ingredientId String?
  ingredient   Ingredient? @relation(fields: [ingredientId], references: [id], onDelete: Restrict)

  subProductId String?
  subProduct   Product? @relation("SubProductRecipe", fields: [subProductId], references: [id], onDelete: Restrict)

  quantity Float // Amount of ingredient/subproduct used per 1 unit of Product
  unit     String @default("unit") // Unit used in recipe (e.g. grams)

  @@unique([productId, ingredientId])
  @@unique([productId, subProductId])
  @@index([productId])
  @@index([ingredientId])
  @@index([subProductId])
}

// A Sale transaction
model Sale {
  id     String @id @default(cuid())
  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  totalAmount Float
  dateTime    DateTime @default(now())

  items SaleItem[]

  @@index([dateTime])
  @@index([userId])
  @@index([organizationId])
}

// Individual items in a Sale
model SaleItem {
  id String @id @default(cuid())

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int
  unitPrice Float // Snapshot of price at time of sale
  unitCost  Float @default(0) // Snapshot of cost at time of sale

  @@index([saleId])
  @@index([productId])
}

// Fixed Monthly Costs (e.g. Rent, Salaries, Services)
model FixedCost {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  amount      Float // Monthly amount
  category    String? // e.g. "Operativo", "Administrativo"
  isActive    Boolean @default(true)
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
}
